<modification>	<id>Автоматический фильтр товаров</id>	<version>1.1.0</version>	<vqmver>2.1.5</vqmver>	<author>by fJ - inspire-technology.com</author>	<file name="admin/controller/common/header.php">        <operation>            <search position="after"><![CDATA[            $this->data['text_country'] = $this->language->get('text_country');            ]]></search>            <add><![CDATA[		// Start filter		$this->data['text_filter'] = $this->language->get('text_filter');		$this->data['text_filter_group'] = $this->language->get('text_filter_group');		// End filter            ]]></add>        </operation>				<operation>            <search position="after"><![CDATA[            $this->data['category'] = $this->url->link('catalog/category', 'token=' . $this->session->data['token'], 'SSL');            ]]></search>            <add><![CDATA[// Start filter            $this->load->model('setting/extension');            $extensions = $this->model_setting_extension->getInstalled('module');            $extension = 'filter';            if (in_array($extension, $extensions)) {                $this->data['filter'] = $this->url->link('catalog/filter', 'token=' . $this->session->data['token'], 'SSL');				$this->data['filter_group'] = $this->url->link('catalog/filter_group', 'token=' . $this->session->data['token'], 'SSL');            }else{                $this->data['filter'] = '';				$this->data['filter_group'] = '';            }            // End filter            ]]></add>        </operation>	</file>	<file name="admin/language/russian/common/header.php">        <operation>            <search position="after"><![CDATA[            $_['text_category']            ]]></search>            <add><![CDATA[// Start filter$_['text_filter']                       = 'Фильтр товаров';$_['text_filter_group']                 = 'Группы фильтров';// End filter            ]]></add>        </operation>	</file>	<file name="admin/language/english/common/header.php">        <operation>            <search position="after"><![CDATA[            $_['text_category']            ]]></search>            <add><![CDATA[// Start filter$_['text_filter']                       = 'Filter';$_['text_filter_group']                 = 'Filter group';// End filter            ]]></add>        </operation>	</file>    <file name="admin/view/template/common/header.tpl">        <operation>            <search position="after"><![CDATA[            <li><a href="<?php echo $product; ?>"><?php echo $text_product; ?></a></li>            ]]></search>            <add><![CDATA[          <!--Start filter-->          <?php if($filter != ''){ ?>          <li>			<a href="<?php echo $filter; ?>" class="parent"><?php echo $text_filter; ?></a>			<ul style="display: none; visibility: hidden;">				<li><a href="<?php echo $filter; ?>"><?php echo $text_filter; ?></a></li>				<li><a href="<?php echo $filter_group; ?>"><?php echo $text_filter_group; ?></a></li>			</ul>		  </li>          <?php } ?>          <!--End filter-->            ]]></add>        </operation>	</file>	<file name="catalog/controller/product/category.php">        <operation>            <search position="before" index="1"><![CDATA[            if (isset($this->request->get['page'])) {            ]]></search>            <add><![CDATA[// Start filter	   if (isset($this->request->get['filter'])) {	        $filter = $this->request->get['filter'];	   } else {	        $filter = '';	   }// End filter            ]]></add>        </operation>		<operation>            <search position="before" index="2,3,4"><![CDATA[            if (isset($this->request->get['limit'])) {            ]]></search>            <add><![CDATA[	        // Start filter	        if (isset($this->request->get['filter'])) {	          $url .= '&filter=' . $this->request->get['filter'];	        }	        // End filter            ]]></add>        </operation>		<operation>            <search position="before" index="2"><![CDATA[            if (isset($this->request->get['page'])) {            ]]></search>            <add><![CDATA[	        // Start filter	        if (isset($this->request->get['filter'])) {	          $url .= '&filter=' . $this->request->get['filter'];	        }	        // End filter            ]]></add>        </operation>		<operation>            <search position="replace" index="1,2"><![CDATA[            $product_total = $this->model_catalog_product->getTotalProducts($data);            ]]></search>            <add><![CDATA[	        // Start filter	        $product_total = $this->model_catalog_product->getTotalProducts($data, $filter);	        // End filter            ]]></add>        </operation>		<operation>            <search position="replace"><![CDATA[            $results = $this->model_catalog_product->getProducts($data);            ]]></search>            <add><![CDATA[	        // Start filter	        $results = $this->model_catalog_product->getProducts($data, $filter);	        // End filter            ]]></add>        </operation>		<operation>            <search position="before"><![CDATA[            'href'  => $this->url->link('product/category', 'path=' . $this->request->get['path'] . '_' . $result['category_id'] . $url)            ]]></search>            <add><![CDATA[// Start filter					'count' => $product_total,// End filter            ]]></add>        </operation>		<operation>            <search position="replace" index="1"><![CDATA[			 if ($category_info) {            ]]></search>            <add><![CDATA[	        // Start filter				if ($category_info || $path_id == 0) {										if ($path_id == 0) {						$category_info['name'] = $this->language->get('text_all_products');					}						        // End filter            ]]></add>        </operation>		<operation>            <search position="replace" index="1"><![CDATA[			 if ($category_info) {            ]]></search>            <add><![CDATA[	        // Start filter				if ($category_info || $category_id == 0) {					if ($category_id == 0) {						$category_info = array('name' => $this->language->get('text_all_products'),							'seo_title' => '',							'meta_description' => '',							'meta_keyword' => '',							'seo_h1' => $this->language->get('text_all_products'),							'image' => '',							'description' => '');					}			        // End filter            ]]></add>        </operation>	</file>		<file name="catalog/model/catalog/product.php">        <operation>            <search position="replace"><![CDATA[public function getProducts($data = array()) {            ]]></search>            <add><![CDATA[	    public function getProducts($data = array(), $filter=0) {             ]]></add>        </operation>		<operation>            <search position="replace"><![CDATA[            $product_data = $this->cache->get('product.' . (int)$this->config->get('config_language_id') . '.' . (int)$this->config->get('config_store_id') . '.' . (int)$customer_group_id . '.' . $cache);            ]]></search>            <add><![CDATA[// Start filter change	    $product_data = $this->cache->get('product.' . (int)$this->config->get('config_language_id') . '.' . (int)$this->config->get('config_store_id') . '.' . (int)$customer_group_id . '.'.md5($filter). '.'. $cache); // End filter            ]]></add>        </operation>		<operation>            <search position="replace"><![CDATA[            $product_data = $this->cache->get('product.total.' . (int)$this->config->get('config_language_id') . '.' . (int)$this->config->get('config_store_id') . '.' . (int)$customer_group_id . '.' . $cache);            ]]></search>            <add><![CDATA[// Start filter change	    $product_data = $this->cache->get('product.total.' . (int)$this->config->get('config_language_id') . '.' . (int)$this->config->get('config_store_id') . '.' . (int)$customer_group_id . '.'.md5($filter). '.'. $cache); // End filter            ]]></add>        </operation>				<operation>            <search position="before"><![CDATA[            $sql = "SELECT p.product_id, (SELECT AVG(rating) AS total FROM " . DB_PREFIX . "review r1 WHERE r1            ]]></search>            <add><![CDATA[			// Start filter			$currency_value = $this->currency->getValue();			$tax_rate = $this->tax->getTax(100, 9);						$sql_add_table_prices = '';			$sql_where_prices = '';			$sql_where_manufacteurs = '';			$sql_add_table_options = '';			$sql_where_options = '';			$sql_add_table_attributes = '';			$sql_where_attributes = '';			if ($filter) {			  foreach (explode(';', $filter) as $option) {				$values = explode(':', $option);				if ($values[0] == 'm') {					$sql_where_manufacteurs = ' AND p.manufacturer_id IN (' . $this->db->escape($values[1]) . ')';				}				if (preg_match('/o_\d+/', $values[0])) {					$option_id = $this->db->escape($values[0]);					$sql_add_table_options .= ' LEFT JOIN ' . DB_PREFIX . 'product_option_value pov' . $option_id . ' ON (p.product_id = pov' . $option_id . '.product_id)';										$sql_where_options .= ' AND pov' . $option_id . '.option_value_id IN (' . $this->db->escape($values[1]) .') AND (pov' . $option_id . '.subtract=0 OR pov' . $option_id . '.subtract=1 AND pov' . $option_id . '.quantity > 0)';				}				if (preg_match('/a_\d+/', $values[0])) {					$attribute_id = $this->db->escape($values[0]);					$sql_add_table_attributes .= " LEFT JOIN " . DB_PREFIX . "product_attribute atr" . $attribute_id . " ON (p.product_id = atr" . $attribute_id . ".product_id)";					$get_id = explode("_", $values[0]);										$values[1] = explode(",", $values[1]);					for ($i = 0; $i < count($values[1]); $i++) {						$values[1][$i] = $this->db->escape($values[1][$i]);					}										$values[1] = "'" . implode("','", $values[1]) . "'";										$sql_where_attributes .= " AND (atr" . $attribute_id . ".language_id = '" . (int)$this->config->get('config_language_id') . "' AND atr" . $attribute_id . ".attribute_id = '" . (int)$get_id[1] . "' AND atr" . $attribute_id . ".text IN (" . $values[1] . "))";				}				if ($values[0] == 'p') {									$values[1] = explode(",", $values[1]);					if (!isset($values[1][0])) {						$values[1][0] = 0;					} else {						$values[1][0] /= $currency_value;					}										if (!isset($values[1][1])) {						$values[1][1] = 9999999999;					} else {						$values[1][1] /= $currency_value;					}										for ($i = 0; $i < 2; $i++) {						$values[1][$i] = $this->db->escape($values[1][$i]);					}										if (!empty($data['filter_category_id'])) {						$category_id = ' AND ct.category_id IN (' . $data['filter_category_id'] . ')';					} else {						$category_id = '';					}									$sql_add_table_prices .= " LEFT JOIN (SELECT pr.product_id, pr.price, (SELECT pd2.price FROM `" . DB_PREFIX . "product_discount` pd2 WHERE pd2.product_id = pr.product_id AND pd2.customer_group_id = '" . $customer_group_id . "' AND pd2.quantity = '1' AND ((pd2.date_start = '0000-00-00' OR pd2.date_start < NOW()) AND (pd2.date_end = '0000-00-00' OR pd2.date_end > NOW()))  ORDER BY pd2.priority ASC, pd2.price ASC LIMIT 1) discount, (SELECT ps.price FROM `" . DB_PREFIX . "product_special` ps WHERE ps.product_id = pr.product_id AND ps.customer_group_id = '" . $customer_group_id . "' AND ((ps.date_start = '0000-00-00' OR ps.date_start < NOW()) AND (ps.date_end = '0000-00-00' OR ps.date_end > NOW())) ORDER BY ps.priority ASC, ps.price ASC LIMIT 1) special FROM `" . DB_PREFIX . "product` pr LEFT JOIN `" . DB_PREFIX . "product_to_category` ct ON (pr.product_id = ct.product_id) WHERE pr.status = '1'" . $category_id . ") tb ON (p.product_id = tb.product_id)";					$sql_where_prices .= "AND tb.price >= '" . $values[1][0] . "' AND (tb.discount IS NULL OR tb.discount >= '" . $values[1][0] . "') AND (tb.special IS NULL OR tb.special >= '" . $values[1][0] . "') AND tb.price <= '" . $values[1][1] . "' AND (tb.discount IS NULL OR tb.discount <= '" . $values[1][1] . "') AND (tb.special IS NULL OR tb.special <= '" . $values[1][1] . "')";				}			  }			}			// End filter            ]]></add>        </operation>		<operation>            <search position="after"><![CDATA[            $sql = "SELECT p.product_id, (SELECT AVG(rating) AS total FROM " . DB_PREFIX . "review r1 WHERE r1.product_id = p.product_id AND r1.status = '1' GROUP BY r1.product_id) AS rating FROM " . DB_PREFIX . "product p LEFT JOIN " . DB_PREFIX . "product_description pd ON (p.product_id = pd.product_id) LEFT JOIN " . DB_PREFIX . "product_to_store p2s ON (p.product_id = p2s.product_id)";             ]]></search>            <add><![CDATA[			$sql .= $sql_add_table_options;			$sql .= $sql_add_table_attributes;			$sql .= $sql_add_table_prices;            ]]></add>        </operation>		<operation>            <search position="before"><![CDATA[            $sql .= " GROUP BY p.product_id";            ]]></search>            <add><![CDATA[			$sql .= $sql_where_manufacteurs;			$sql .= $sql_where_attributes;			$sql .= $sql_where_options;			$sql .= $sql_where_prices; //print_r($sql);            ]]></add>        </operation>		<operation>            <search position="after"><![CDATA[           $sql = "SELECT COUNT(DISTINCT p.product_id) AS total FROM " . DB_PREFIX . "product p LEFT JOIN " . DB_PREFIX . "product_description pd ON (p.product_id = pd.product_id) LEFT JOIN " . DB_PREFIX . "product_to_store p2s ON (p.product_id = p2s.product_id)";            ]]></search>            <add><![CDATA[			$sql .= $sql_add_table_options;			$sql .= $sql_add_table_attributes;			$sql .= $sql_add_table_prices;            ]]></add>        </operation>		<operation>            <search position="after"><![CDATA[            $sql .= " WHERE pd.language_id = '" . (int)$this->config->get('config_language_id') . "' AND p.status = '1' AND p.date_available <= NOW() AND p2s.store_id = '" . (int)$this->config->get('config_store_id') . "'";            ]]></search>            <add><![CDATA[			$sql .= $sql_where_manufacteurs;			$sql .= $sql_where_attributes;			$sql .= $sql_where_options;			$sql .= $sql_where_prices; //print_r($sql.'<br><br>');            ]]></add>        </operation>		<operation>            <search position="replace"><![CDATA[            public function getTotalProducts($data = array()) {            ]]></search>            <add><![CDATA[// Start filter change	    public function getTotalProducts($data = array(), $filter = 0) {			if ($this->customer->isLogged()) {				$customer_group_id = $this->customer->getCustomerGroupId();			} else {				$customer_group_id = $this->config->get('config_customer_group_id');			}// End filter		// Start filter			$currency_value = $this->currency->getValue();						$sql_add_table_prices = '';			$sql_where_prices = '';			$sql_where_manufacteurs = '';			$sql_add_table_options = '';			$sql_where_options = '';			$sql_add_table_attributes = '';			$sql_where_attributes = '';						if ($filter) {			  foreach (explode(';', $filter) as $option) {				$values = explode(':', $option);				if ($values[0] == 'm') {					$sql_where_manufacteurs = ' AND p.manufacturer_id IN (' . $this->db->escape($values[1]) . ')';				}				if (preg_match('/o_\d+/', $values[0])) {					$option_id = $this->db->escape($values[0]);					$sql_add_table_options .= ' LEFT JOIN ' . DB_PREFIX . 'product_option_value pov' . $option_id . ' ON (p.product_id = pov' . $option_id . '.product_id)';										$sql_where_options .= ' AND pov' . $option_id . '.option_value_id IN (' . $this->db->escape($values[1]) .') AND (pov' . $option_id . '.subtract=0 OR pov' . $option_id . '.subtract=1 AND pov' . $option_id . '.quantity > 0)';				}				if (preg_match('/a_\d+/', $values[0])) {					$attribute_id = $this->db->escape($values[0]);					$sql_add_table_attributes .= ' LEFT JOIN ' . DB_PREFIX . 'product_attribute atr' . $attribute_id . ' ON (p.product_id = atr' . $attribute_id . '.product_id)';					$get_id = explode("_", $values[0]);										$values[1] = explode(",", $values[1]);					for ($i = 0; $i < count($values[1]); $i++) {						$values[1][$i] = $this->db->escape($values[1][$i]);					}										$values[1] = "'" . implode("','", $values[1]) . "'";										$sql_where_attributes .= " AND (atr" . $attribute_id . ".language_id = '" . (int)$this->config->get('config_language_id') . "' AND atr" . $attribute_id . ".attribute_id = '" . (int)$get_id[1] . "' AND atr" . $attribute_id . ".text IN (" . $values[1] . "))";				}				if ($values[0] == 'p') {										$values[1] = explode(",", $values[1]);					if (!isset($values[1][0])) {						$values[1][0] = 0;					} else {						$values[1][0] = $values[1][0]/$currency_value;					}										if (!isset($values[1][1])) {						$values[1][1] = 9999999;					} else {						$values[1][1] = $values[1][1]/$currency_value;					}										for ($i = 0; $i < 2; $i++) {						$values[1][$i] = (float)$values[1][$i];					}										if (!empty($data['filter_category_id'])) {						$category_id = ' AND ct.category_id IN (' . $data['filter_category_id'] . ')';					} else {						$category_id = '';					}										$sql_add_table_prices .= " LEFT JOIN (SELECT pr.product_id, pr.price, (SELECT pd2.price FROM `" . DB_PREFIX . "product_discount` pd2 WHERE pd2.product_id = pr.product_id AND pd2.customer_group_id = '" . $customer_group_id . "' AND pd2.quantity = '1' AND ((pd2.date_start = '0000-00-00' OR pd2.date_start < NOW()) AND (pd2.date_end = '0000-00-00' OR pd2.date_end > NOW()))  ORDER BY pd2.priority ASC, pd2.price ASC LIMIT 1) discount, (SELECT ps.price FROM `" . DB_PREFIX . "product_special` ps WHERE ps.product_id = pr.product_id AND ps.customer_group_id = '" . $customer_group_id . "' AND ((ps.date_start = '0000-00-00' OR ps.date_start < NOW()) AND (ps.date_end = '0000-00-00' OR ps.date_end > NOW())) ORDER BY ps.priority ASC, ps.price ASC LIMIT 1) special FROM `" . DB_PREFIX . "product` pr LEFT JOIN `" . DB_PREFIX . "product_to_category` ct ON (pr.product_id = ct.product_id) WHERE pr.status = '1'" . $category_id . ") tb ON (p.product_id = tb.product_id)";					$sql_where_prices .= "AND tb.price >= '" . $values[1][0] . "' AND (tb.discount IS NULL OR tb.discount >= '" . $values[1][0] . "') AND (tb.special IS NULL OR tb.special >= '" . $values[1][0] . "') AND tb.price <= '" . $values[1][1] . "' AND (tb.discount IS NULL OR tb.discount <= '" . $values[1][1] . "') AND (tb.special IS NULL OR tb.special <= '" . $values[1][1] . "')";				}			  }			} 			// End filter            ]]></add>        </operation>	</file>	<file name="catalog/language/english/product/category.php">		<operation>			<search position="before" index="1"><![CDATA[			$_['text_error']			]]></search>			<add trim="true"><![CDATA[			$_['text_all_products']	= 'All Products';			]]></add>		</operation>	</file>	<file name="catalog/language/russian/product/category.php">		<operation>			<search position="before" index="1"><![CDATA[			$_['text_error']			]]></search>			<add trim="true"><![CDATA[			$_['text_all_products']	= 'Все товары';			]]></add>		</operation>	</file>	<file name="catalog/view/theme/magnetoplan/template/common/header.tpl">		<operation>			<search position="after" index="1"><![CDATA[			<link rel="stylesheet" type="text/css" href="catalog/view/theme/magnetoplan/stylesheet/stylesheet.css" />			]]></search>			<add trim="true"><![CDATA[			<link rel="stylesheet" type="text/css" href="catalog/view/theme/magnetoplan/stylesheet/filter.css" />			]]></add>		</operation>	</file>	<file name="catalog/controller/module/currency.php">		<operation>			<search position="after" index="1"><![CDATA[			if (isset($this->request->post['currency_code'])) {			]]></search>			<add trim="true"><![CDATA[			preg_match("{(filter=[^&$]*?)p:([\d\.]+),([\d\.]+)}i", $this->request->post['redirect'], $price_matches);			$this->request->post['redirect'] = preg_replace("{(filter=[^&$]*?)p:([\d\.]+),([\d\.]+)[;]*}i", "$1", $this->request->post['redirect']);			]]></add>		</operation>	</file></modification>